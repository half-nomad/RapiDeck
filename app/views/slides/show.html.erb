<div class="min-h-screen bg-[#1e1e1e] text-white p-8">
  <div class="max-w-7xl mx-auto">
    <% if flash[:success] %>
      <div class="bg-green-500/10 border border-green-500 text-green-300 px-4 py-3 rounded mb-6">
        <%= flash[:success] %>
      </div>
    <% end %>

    <% if flash[:error] %>
      <div class="bg-red-500/10 border border-red-500 text-red-300 px-4 py-3 rounded mb-6">
        <%= flash[:error] %>
      </div>
    <% end %>

    <header class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold mb-1" style="font-family: 'Pretendard', sans-serif;">
          <%= @slide_data[:title] %>
        </h1>
        <p class="text-sm text-gray-400">
          생성 시간: <%= @slide_data[:generated_at].strftime('%Y-%m-%d %H:%M') %>
        </p>
      </div>
      <div class="flex gap-3">
        <%= link_to "새 슬라이드 만들기", new_slide_path, class: "px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" %>
        <button
          onclick="downloadHTML()"
          class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-lg transition"
        >
          HTML 다운로드
        </button>
      </div>
    </header>

    <!-- 2열 레이아웃: 왼쪽 슬라이드, 오른쪽 채팅 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- 왼쪽: 슬라이드 미리보기 -->
      <div class="space-y-6">
        <div class="bg-[#2d2d2d] border border-gray-700 rounded-lg p-4">
          <div class="mb-4 text-sm text-gray-400">
            슬라이드 미리보기 (16:9 비율)
          </div>
          <div class="bg-black rounded-lg overflow-hidden" style="aspect-ratio: 16/9;">
            <iframe
              id="slide-iframe"
              srcdoc="<%= ERB::Util.html_escape(@slide_data[:html_code]) %>"
              class="w-full h-full border-0"
              sandbox="allow-scripts"
            ></iframe>
          </div>
        </div>

        <div class="p-4 bg-[#2d2d2d] border border-gray-700 rounded-lg">
          <details>
            <summary class="cursor-pointer font-semibold hover:text-cyan-400 transition">
              HTML 코드 보기
            </summary>
            <pre class="mt-4 p-4 bg-[#1e1e1e] rounded overflow-x-auto text-xs"><code><%= @slide_data[:html_code] %></code></pre>
          </details>
        </div>
      </div>

      <!-- 오른쪽: 채팅 영역 -->
      <div class="bg-[#2d2d2d] border border-gray-700 rounded-lg flex flex-col" style="height: calc(100vh - 200px);" data-controller="chat">
        <div class="p-4 border-b border-gray-700">
          <h2 class="text-xl font-semibold">슬라이드 수정</h2>
          <p class="text-sm text-gray-400 mt-1">채팅으로 슬라이드를 수정할 수 있습니다</p>
        </div>

        <!-- 채팅 메시지 영역 -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4" data-chat-target="messages">
          <% if session[:chat_messages] && session[:chat_messages].any? %>
            <% session[:chat_messages].each do |message| %>
              <div class="flex <%= message[:role] == 'user' ? 'justify-end' : 'justify-start' %>">
                <div class="max-w-[80%] <%= message[:role] == 'user' ? 'bg-cyan-600' : 'bg-[#3d3d3d]' %> rounded-lg p-3">
                  <div class="text-xs text-gray-300 mb-1">
                    <%= message[:role] == 'user' ? '나' : 'AI' %>
                  </div>
                  <div class="text-sm whitespace-pre-wrap"><%= message[:content] %></div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center text-gray-500 mt-12">
              <p class="mb-2">💬</p>
              <p>아직 대화가 없습니다</p>
              <p class="text-xs mt-1">수정 사항을 입력해보세요</p>
            </div>
          <% end %>
        </div>

        <!-- 채팅 입력창 -->
        <div class="p-4 border-t border-gray-700">
          <%= form_with url: update_current_slide_path, method: :patch, class: "flex gap-2", data: { turbo: false } do |f| %>
            <%= f.text_area :message,
              rows: 2,
              class: "flex-1 bg-[#1e1e1e] border border-gray-700 rounded-lg p-3 text-white focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition resize-none",
              placeholder: "예: 첫 번째 슬라이드의 제목을 더 크게 만들어줘",
              required: true
            %>
            <%= f.submit "전송", class: "px-6 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold rounded-lg transition-all cursor-pointer" %>
          <% end %>
          <p class="text-xs text-gray-500 mt-2">
            💡 수정 요청 시 슬라이드가 재생성됩니다 (1-2분 소요)
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function downloadHTML() {
    const htmlContent = <%= @slide_data[:html_code].to_json.html_safe %>;
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '<%= @slide_data[:title].gsub(/[^0-9A-Za-z가-힣\s]/, '') %>_<%= Time.current.strftime('%Y%m%d_%H%M%S') %>.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
